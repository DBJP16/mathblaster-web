<!DOCTYPE html>
<html>
<head>
    <title>Math Blaster with Profiles</title>
    <style>
        canvas { border: 1px solid white; background: black; display: none; }
        body { display: flex; flex-direction: column; align-items: center; background: #222; color: white; font-family: Arial, sans-serif; }
        #score, #question, #lives { font-size: 24px; margin: 10px; display: none; }
        #profileScreen { text-align: center; }
        #gameScreen { display: none; }
        #gameOverScreen { display: none; text-align: center; }
    </style>
</head>
<body>
    <div id="profileScreen">
        <h1>Create Your Math Blaster Profile</h1>
        <input type="text" id="usernameInput" placeholder="Enter your username">
        <button onclick="startGame()">Start Game</button>
    </div>
    <div id="gameScreen">
        <div id="score">Score: 0</div>
        <div id="lives">Lives: 3</div>
        <div id="question"></div>
        <canvas id="gameCanvas" width="800" height="600"></canvas>
    </div>
    <div id="gameOverScreen">
        <h1>Game Over</h1>
        <p id="finalScore"></p>
        <button onclick="restartGame()">Play Again</button>
    </div>

    <script>
        console.log('Script starting...'); // Immediate log

        window.onload = function() {
            console.log('DOM loaded'); // Confirm DOM ready

            const profileScreen = document.getElementById('profileScreen');
            const gameScreen = document.getElementById('gameScreen');
            const gameOverScreen = document.getElementById('gameOverScreen');
            const usernameInput = document.getElementById('usernameInput');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const scoreDisplay = document.getElementById('score');
            const livesDisplay = document.getElementById('lives');
            const questionDisplay = document.getElementById('question');
            const finalScoreDisplay = document.getElementById('finalScore');

            console.log('Canvas:', canvas ? 'Found' : 'Not found'); // Verify canvas

            let player = { x: 400, y: 550, width: 40, height: 20 };
            let enemies = [];
            let bullets = [];
            let currentQuestion = {};
            let score = 0;
            let lives = 3;
            let username = '';
            let rightPressed = false;
            let leftPressed = false;
            let gameActive = false;

            function generateQuestion() {
                const num1 = Math.floor(Math.random() * 10) + 1;
                const num2 = Math.floor(Math.random() * 10) + 1;
                currentQuestion = { num1: num1, num2: num2, answer: num1 + num2 };
                questionDisplay.textContent = `${username}, what is ${num1} + ${num2}?`;
                console.log(`Question: ${num1} + ${num2} = ${currentQuestion.answer}`);
            }

            function spawnEnemy() {
                const isCorrect = Math.random() < 0.5;
                const displayNumber = isCorrect ? currentQuestion.answer : Math.floor(Math.random() * 20) + 1;
                enemies.push({
                    x: Math.random() * (canvas.width - 30),
                    y: 0,
                    width: 30,
                    height: 30,
                    speed: 2,
                    number: displayNumber,
                    isCorrect: isCorrect
                });
                console.log(`Enemy spawned: ${displayNumber} (Correct: ${isCorrect})`);
            }

            window.startGame = function() {
                console.log('Game starting...');
                username = usernameInput.value.trim() || 'Player';
                profileScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                canvas.style.display = 'block';
                scoreDisplay.style.display = 'block';
                livesDisplay.style.display = 'block';
                questionDisplay.style.display = 'block';

                score = 0;
                lives = 3;
                enemies = [];
                bullets = [];
                scoreDisplay.textContent = `Score: ${score}`;
                livesDisplay.textContent = `Lives: ${lives}`;
                gameActive = true;

                generateQuestion();
                setInterval(spawnEnemy, 2000);
                update();
            };

            window.restartGame = function() {
                console.log('Restarting game...');
                gameOverScreen.style.display = 'none';
                gameScreen.style.display = 'block';
                canvas.style.display = 'block';
                scoreDisplay.style.display = 'block';
                livesDisplay.style.display = 'block';
                questionDisplay.style.display = 'block';

                score = 0;
                lives = 3;
                enemies = [];
                bullets = [];
                scoreDisplay.textContent = `Score: ${score}`;
                livesDisplay.textContent = `Lives: ${lives}`;
                gameActive = true;

                generateQuestion();
                update();
            };

            document.addEventListener('keydown', (e) => {
                if (!gameActive) return;
                console.log(`Key pressed: ${e.key}`); // Log every key press
                if (e.key === 'ArrowRight') rightPressed = true;
                if (e.key === 'ArrowLeft') leftPressed = true;
                if (e.key === ' ') {
                    e.preventDefault();
                    bullets.push({ x: player.x + player.width / 2, y: player.y, speed: 5 });
                    console.log('Bullet fired, count:', bullets.length);
                }
            });

            document.addEventListener('keyup', (e) => {
                if (e.key === 'ArrowRight') rightPressed = false;
                if (e.key === 'ArrowLeft') leftPressed = false;
            });

            function update() {
                if (!gameActive) return;

                console.log('Update tick'); // Log each frame
                ctx.fillStyle = 'black';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                if (rightPressed && player.x < canvas.width - player.width) player.x += 5;
                if (leftPressed && player.x > 0) player.x -= 5;
                ctx.fillStyle = 'white';
                ctx.beginPath();
                ctx.moveTo(player.x, player.y);
                ctx.lineTo(player.x + player.width / 2, player.y - player.height);
                ctx.lineTo(player.x + player.width, player.y);
                ctx.fill();

                enemies.forEach((enemy, index) => {
                    enemy.y += enemy.speed;
                    ctx.fillStyle = 'red';
                    ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
                    ctx.fillStyle = 'white';
                    ctx.fillText(enemy.number, enemy.x + 10, enemy.y + 20);
                    if (enemy.y > canvas.height) {
                        enemies.splice(index, 1);
                        lives -= 1;
                        livesDisplay.textContent = `Lives: ${lives}`;
                        console.log('Enemy missed, lives:', lives);
                        if (lives <= 0) endGame();
                    }
                });

                bullets.forEach((bullet, bIndex) => {
                    bullet.y -= bullet.speed;
                    ctx.fillStyle = 'yellow';
                    ctx.fillRect(bullet.x, bullet.y, 5, 15); // Increased size for visibility
                    enemies.forEach((enemy, eIndex) => {
                        if (bullet.x > enemy.x && bullet.x < enemy.x + enemy.width &&
                            bullet.y > enemy.y && bullet.y < enemy.y + enemy.height) {
                            if (enemy.isCorrect) {
                                score += 1;
                                scoreDisplay.textContent = `Score: ${score}`;
                                console.log('Hit correct enemy! Score:', score);
                            }
                            enemies.splice(eIndex, 1);
                            bullets.splice(bIndex, 1);
                        }
                    });
                    if (bullet.y < 0) bullets.splice(bIndex, 1);
                });

                requestAnimationFrame(update);
            }

            function endGame() {
                gameActive = false;
                gameScreen.style.display = 'none';
                gameOverScreen.style.display = 'block';
                finalScoreDisplay.textContent = `${username}, your final score: ${score}`;
            }
        };
    </script>
</body>
</html>